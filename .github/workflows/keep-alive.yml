name: keep-streamlit-supabase-alive

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  ping-streamlit:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Streamlit Cloud app
        env:
          STREAMLIT_APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          if [ -z "$STREAMLIT_APP_URL" ]; then
            echo "STREAMLIT_APP_URL secret is not set" >&2
            exit 1
          fi
          echo "Pinging Streamlit app at $STREAMLIT_APP_URL"

          # Use -w to show HTTP status code and -o to save body to temp file
          HTTP_CODE=$(curl -fsSL --max-redirs 10 --max-time 30 \
            -w "%{http_code}" \
            -o /tmp/streamlit_response.html \
            "$STREAMLIT_APP_URL")

          echo "HTTP Status Code: $HTTP_CODE"

          # Show first 500 chars of response for verification
          echo "Response preview:"
          head -c 500 /tmp/streamlit_response.html
          echo ""

          # Verify we got a successful response
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✓ Successfully pinged Streamlit app (HTTP $HTTP_CODE)"
          else
            echo "✗ Failed to ping Streamlit app (HTTP $HTTP_CODE)" >&2
            exit 1
          fi

  ping-supabase:
    runs-on: ubuntu-latest
    needs: ping-streamlit
    steps:
      - name: Ping Supabase REST endpoint
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "Supabase secrets are not set; skipping" >&2
            exit 0
          fi
          echo "Pinging Supabase endpoint"

          HTTP_CODE=$(curl -fsSL --max-time 30 \
            -w "%{http_code}" \
            -o /tmp/supabase_response.json \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/rest/v1/users?select=id&limit=1")

          echo "HTTP Status Code: $HTTP_CODE"
          echo "Response:"
          cat /tmp/supabase_response.json
          echo ""

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✓ Successfully pinged Supabase (HTTP $HTTP_CODE)"
          else
            echo "✗ Failed to ping Supabase (HTTP $HTTP_CODE)" >&2
            exit 1
          fi
